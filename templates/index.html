<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>In-Memory Todo</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-2xl">
      <div class="bg-white shadow rounded-lg p-6">
        <h1 class="text-2xl font-semibold mb-4">To‑Do List</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="space-y-2 mb-4">
              {% for category, msg in messages %}
                <div class="px-4 py-2 rounded text-sm
                            {% if category == 'success' %}bg-green-100 text-green-800
                            {% elif category == 'warning' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-blue-100 text-blue-800{% endif %}">
                  {{ msg }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% if edit_task %}
        <form action="{{ url_for('edit_task', task_id=edit_task.id) }}" method="post" class="mb-6">
          <div class="flex gap-2">
            <input name="title" value="{{ edit_task.title }}" required
                   class="flex-1 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-300" />
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
            <a href="{{ url_for('index') }}" class="bg-gray-100 px-4 py-2 rounded border">Cancel</a>
          </div>
        </form>
        {% endif %}

        <form action="{{ url_for('add_task') }}" method="post" class="mb-6">
          <div class="flex gap-2">
            <input name="title" placeholder="Add a new task..." required
                   class="flex-1 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-300" />
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Add</button>
          </div>
        </form>

        <!-- Feature Branch Content: Stats, Bulk Actions, and Rich Task List -->
        <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Tasks</h2>
        
        <!-- Bulk Actions Panel (Hidden by default) -->
        <div id="bulk-actions-panel" class="hidden mb-4 p-4 bg-blue-50 dark:bg-blue-900 border border-blue-300 dark:border-blue-600 rounded-lg">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                <span id="selected-count">0</span> task(s) selected
              </span>
            </div>
            <button type="button" onclick="clearSelection()" 
                    class="text-sm px-3 py-1 rounded border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-500">
              Clear
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
            <button type="button" onclick="bulkComplete()"
                    class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium">
              Mark Complete
            </button>
            <button type="button" onclick="bulkIncomplete()"
                    class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm font-medium">
              Mark Pending
            </button>
            <button type="button" onclick="showPriorityDialog()"
                    class="px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded text-sm font-medium">
              Change Priority
            </button>
            <button type="button" onclick="showTagsDialog()"
                    class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-medium">
              Add Tags
            </button>
            <button type="button" onclick="bulkDelete()"
                    class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-medium">
              Delete
            </button>
          </div>
        </div>
        
        <div class="space-y-2">
          {% if tasks %}
            {% for t in tasks %}
              <div class="flex items-start justify-between p-4 border border-gray-200 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition task-item" data-task-id="{{ t.id }}">
                <!-- Checkbox for selection -->
                <div class="flex items-start gap-3 flex-1">
                  <input type="checkbox" class="task-checkbox mt-1 w-4 h-4 rounded border-gray-300 dark:border-gray-600" 
                         data-task-id="{{ t.id }}" onchange="updateSelection()" />
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="w-8 h-8 flex items-center justify-center rounded-full text-white text-sm font-semibold 
                                  {% if t.status == 'Completed' %}bg-green-500{% elif t.priority == 'High' %}bg-red-500{% elif t.priority == 'Medium' %}bg-yellow-500{% else %}bg-blue-500{% endif %}">
                        {{ t.id }}
                      </div>
                      <div class="flex-1">
                        <div class="font-medium text-gray-900 dark:text-white {% if t.status == 'Completed' %}line-through text-gray-500 dark:text-gray-400{% endif %}">{{ t.title }}</div>
                        <div class="text-xs mt-1 flex flex-wrap gap-2">
                          <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded">
                            Status: <span class="font-semibold {% if t.status == 'Completed' %}text-green-600 dark:text-green-400{% else %}text-yellow-600 dark:text-yellow-400{% endif %}">{{ t.status }}</span>
                          </span>
                          <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded">
                            Priority: <span class="font-semibold">{{ t.priority }}</span>
                          </span>
                          {% if t.due_date %}
                            <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded">
                              Due: {{ t.due_date.strftime('%Y-%m-%d %H:%M') }}
                            </span>
                          {% endif %}
                          {% if t.tags %}
                            {% for tag in t.tags.split(',') %}
                              <span class="px-2 py-1 bg-purple-200 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded text-xs">{{ tag.strip() }}</span>
                            {% endfor %}
                          {% endif %}
                          <!-- Integrated individual actions from Main logic, styled for Feature layout -->
                          <span class="ml-auto flex gap-2">
                            <a href="{{ url_for('edit_task', task_id=t.id) }}" class="text-blue-600 hover:text-blue-800">Edit</a>
                            <a href="{{ url_for('delete_task', task_id=t.id) }}" class="text-red-600 hover:text-red-800">Delete</a>
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Comments Section -->
                    <div class="mt-4 border-t border-gray-200 dark:border-gray-600 pt-4">
                      <div class="flex items-center justify-between mb-3">
                        <button onclick="toggleComments({{ t.id }})" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium flex items-center gap-1">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                          </svg>
                          Comments (<span id="comment-count-{{ t.id }}">0</span>)
                        </button>
                      </div>
                      
                      <div id="comments-{{ t.id }}" class="hidden space-y-3">
                        <!-- Comments List -->
                        <div id="comments-list-{{ t.id }}" class="space-y-2">
                          <!-- Comments will be loaded here -->
                        </div>
                        
                        <!-- Add Comment Form -->
                        <div class="border-t border-gray-200 dark:border-gray-600 pt-3">
                          <form onsubmit="addComment(event, {{ t.id }})" class="flex gap-2">
                            <input type="text" id="comment-input-{{ t.id }}" placeholder="Add a comment..." maxlength="1000"
                                   class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-500" />
                            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">Add</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <!-- From Main: Empty State -->
            <div class="text-center text-gray-500 py-8">No tasks yet — add your first task above.</div>
          {% endif %}
        </div>
      </div>
      <p class="text-center text-xs text-gray-400 mt-3">In-memory demo — no database used.</p>
    </div>

    <!-- Feature Branch Scripts -->
    <script>
      // Load and display stats
      async function loadStats() {
        try {
          const response = await fetch('/api/stats/summary');
          const data = await response.json();
          
          if(document.getElementById('stat-completed-today')) {
             document.getElementById('stat-completed-today').textContent = data.completed_today;
             document.getElementById('stat-completed-week').textContent = data.completed_week;
             document.getElementById('stat-overdue').textContent = data.overdue;
             document.getElementById('stat-pending').textContent = data.total_pending;
             document.getElementById('stat-total-completed').textContent = data.total_completed;
          }
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      // Load and display completion trend chart
      async function loadTrendChart() {
        if(!document.getElementById('trendChart')) return;
        try {
          const response = await fetch('/api/stats/completion-trend?days=7');
          const data = await response.json();
          
          const labels = [];
          const values = [];
          
          for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            labels.push(dateStr);
            values.push(data.trend[dateStr] || 0);
          }
          
          const ctx = document.getElementById('trendChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Tasks Completed',
                data: values,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true, labels: { color: '#6b7280', font: { size: 12 } } }
              },
              scales: {
                y: { beginAtZero: true, ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } },
                x: { ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } }
              }
            }
          });
        } catch (error) {
          console.error('Error loading trend chart:', error);
        }
      }

      // Load and display priority chart
      async function loadPriorityChart() {
        if(!document.getElementById('priorityChart')) return;
        try {
          const response = await fetch('/api/stats/by-priority');
          const data = await response.json();
          
          const ctx = document.getElementById('priorityChart').getContext('2d');
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: Object.keys(data),
              datasets: [{
                data: Object.values(data),
                backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                borderColor: '#1f2937',
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom', labels: { color: '#6b7280', padding: 15, font: { size: 12 } } }
              }
            }
          });
        } catch (error) {
          console.error('Error loading priority chart:', error);
        }
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadTrendChart();
        loadPriorityChart();
      });

      // Comments functionality
      async function toggleComments(taskId) {
        const commentsDiv = document.getElementById(`comments-${taskId}`);
        const isHidden = commentsDiv.classList.contains('hidden');
        
        if (isHidden) {
          commentsDiv.classList.remove('hidden');
          await loadComments(taskId);
        } else {
          commentsDiv.classList.add('hidden');
        }
      }

      async function loadComments(taskId) {
        try {
          const response = await fetch(`/api/comments/${taskId}`);
          const comments = await response.json();
          
          const commentsList = document.getElementById(`comments-list-${taskId}`);
          const commentCount = document.getElementById(`comment-count-${taskId}`);
          
          commentCount.textContent = comments.length;
          
          if (comments.length === 0) {
            commentsList.innerHTML = '<div class="text-sm text-gray-500 dark:text-gray-400 italic">No comments yet</div>';
            return;
          }
          
          commentsList.innerHTML = comments.map(comment => `
            <div class="flex gap-3 p-3 bg-gray-50 dark:bg-gray-600 rounded">
              <div class="flex-1">
                <div class="text-sm text-gray-900 dark:text-white">${escapeHtml(comment.body)}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  ${new Date(comment.created_at).toLocaleString()}
                  ${comment.author_id ? ` • Author #${comment.author_id}` : ''}
                </div>
              </div>
              <button onclick="deleteComment(${comment.id}, ${taskId})" 
                      class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          `).join('');
        } catch (error) {
          console.error('Error loading comments:', error);
        }
      }

      async function addComment(event, taskId) {
        event.preventDefault();
        
        const input = document.getElementById(`comment-input-${taskId}`);
        const body = input.value.trim();
        
        if (!body) return;
        
        try {
          const response = await fetch('/api/comments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              task_id: taskId,
              body: body
            })
          });
          
          if (response.ok) {
            input.value = '';
            await loadComments(taskId);
          } else {
            const error = await response.json();
            alert('Error: ' + error.error);
          }
        } catch (error) {
          console.error('Error adding comment:', error);
          alert('Error adding comment');
        }
      }

      async function deleteComment(commentId, taskId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;
        
        try {
          const response = await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            await loadComments(taskId);
          } else {
            const error = await response.json();
            alert('Error: ' + error.error);
          }
        } catch (error) {
          console.error('Error deleting comment:', error);
          alert('Error deleting comment');
        }
      }

      // Helper function to escape HTML and prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Bulk operations functionality
      let selectedTaskIds = new Set();

      function updateSelection() {
        selectedTaskIds.clear();
        document.querySelectorAll('.task-checkbox:checked').forEach(checkbox => {
          selectedTaskIds.add(parseInt(checkbox.dataset.taskId));
        });
        
        const panel = document.getElementById('bulk-actions-panel');
        const count = document.getElementById('selected-count');
        
        count.textContent = selectedTaskIds.size;
        
        if (selectedTaskIds.size > 0) {
          panel.classList.remove('hidden');
        } else {
          panel.classList.add('hidden');
        }
      }

      function clearSelection() {
        document.querySelectorAll('.task-checkbox:checked').forEach(checkbox => {
          checkbox.checked = false;
        });
        updateSelection();
      }

      async function performBulkAction(action, actionData = {}) {
        if (selectedTaskIds.size === 0) {
          alert('Please select at least one task');
          return;
        }

        try {
          const response = await fetch('/api/bulk-update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              task_ids: Array.from(selectedTaskIds),
              action: action,
              data: actionData
            })
          });

          const result = await response.json();

          if (response.ok) {
            alert(result.message);
            clearSelection();
            // Reload page to reflect changes
            location.reload();
          } else {
            alert('Error: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error performing bulk action:', error);
          alert('Error performing bulk action');
        }
      }

      function bulkComplete() {
        if (confirm(`Mark ${selectedTaskIds.size} task(s) as complete?`)) {
          performBulkAction('complete');
        }
      }

      function bulkIncomplete() {
        if (confirm(`Mark ${selectedTaskIds.size} task(s) as pending?`)) {
          performBulkAction('incomplete');
        }
      }

      function bulkDelete() {
        if (confirm(`Delete ${selectedTaskIds.size} task(s)? This cannot be undone.`)) {
          performBulkAction('delete');
        }
      }

      function showPriorityDialog() {
        const priority = prompt('Enter new priority (Low, Medium, High):', 'Medium');
        if (priority && ['Low', 'Medium', 'High'].includes(priority)) {
          if (confirm(`Change priority to '${priority}' for ${selectedTaskIds.size} task(s)?`)) {
            performBulkAction('priority', { priority: priority });
          }
        } else if (priority !== null) {
          alert('Invalid priority. Please enter Low, Medium, or High.');
        }
      }

      function showTagsDialog() {
        const tags = prompt('Enter tags (comma-separated):', '');
        if (tags !== null && tags.trim()) {
          const mode = confirm(`Append tags? (OK for append, Cancel to replace)`);
          const tagMode = mode ? 'append' : 'replace';
          if (confirm(`${tagMode.charAt(0).toUpperCase() + tagMode.slice(1)} tags for ${selectedTaskIds.size} task(s)?`)) {
            performBulkAction('tags', { tags: tags, tag_mode: tagMode });
          }
        }
      }
    </script>
  </body>
</html>