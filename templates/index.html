<!doctype html>
<html lang="en" class="{% if theme == 'dark' %}dark{% endif %}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Todo Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class'
      }
    </script>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 min-h-screen p-6 relative">
    <!-- Theme Toggle Button -->
    <a href="{{ url_for('toggle_theme') }}" 
       class="fixed top-4 right-4 z-10 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-full p-2 shadow-lg hover:shadow-xl transition-shadow">
      {% if theme == 'dark' %}
        <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
        </svg>
      {% else %}
        <svg class="w-6 h-6 text-gray-800" fill="currentColor" viewBox="0 0 20 20">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
        </svg>
      {% endif %}
    </a>

    <div class="w-full max-w-6xl mx-auto">
      <h1 class="text-4xl font-bold mb-8 text-gray-900 dark:text-white">Task Dashboard</h1>
      
      <!-- Stats Summary -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="stat-completed-today">-</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Completed Today</div>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="stat-completed-week">-</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Completed This Week</div>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="stat-overdue">-</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Overdue</div>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="stat-pending">-</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Pending</div>
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <div class="text-2xl font-bold text-violet-600 dark:text-violet-400" id="stat-total-completed">-</div>
          <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">Total Done</div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Completion Trend Chart -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
          <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Completion Trend (7 days)</h2>
          <canvas id="trendChart"></canvas>
        </div>

        <!-- Priority Distribution -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
          <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Tasks by Priority</h2>
          <canvas id="priorityChart"></canvas>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="space-y-2 mb-4">
              {% for category, msg in messages %}
                <div class="px-4 py-2 rounded text-sm
                            {% if category == 'success' %}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200
                            {% elif category == 'warning' %}bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200
                            {% else %}bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200{% endif %}">
                  {{ msg }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% if edit_task %}
        <form action="{{ url_for('edit_task', task_id=edit_task.id) }}" method="post" class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
          <h3 class="font-semibold mb-4 text-gray-900 dark:text-white">Edit Task</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Title</label>
              <input name="title" value="{{ edit_task.title }}" required
                     class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-300 dark:focus:ring-green-500" />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Due Date</label>
                <input name="due_date" type="datetime-local" value="{% if edit_task.due_date %}{{ edit_task.due_date.isoformat() }}{% endif %}"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-300 dark:focus:ring-green-500" />
              </div>
              <div>
                <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                <select name="priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-300 dark:focus:ring-green-500">
                  <option value="Low" {% if edit_task.priority == 'Low' %}selected{% endif %}>Low</option>
                  <option value="Medium" {% if edit_task.priority == 'Medium' %}selected{% endif %}>Medium</option>
                  <option value="High" {% if edit_task.priority == 'High' %}selected{% endif %}>High</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Tags (comma-separated)</label>
              <input name="tags" value="{{ edit_task.tags or '' }}" placeholder="e.g., work, urgent, bug"
                     class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-300 dark:focus:ring-green-500" />
            </div>
            <div class="flex gap-2 pt-2">
              <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Save</button>
              <a href="{{ url_for('index') }}" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-white px-4 py-2 rounded">Cancel</a>
            </div>
          </div>
        </form>
        {% endif %}

        <form action="{{ url_for('add_task') }}" method="post" class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
          <h3 class="font-semibold mb-4 text-gray-900 dark:text-white">Add New Task</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Title</label>
              <input name="title" placeholder="What needs to be done?" required
                     class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-300 dark:focus:ring-indigo-500" />
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Due Date</label>
                <input name="due_date" type="datetime-local"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-300 dark:focus:ring-indigo-500" />
              </div>
              <div>
                <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                <select name="priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-300 dark:focus:ring-indigo-500">
                  <option value="Low">Low</option>
                  <option value="Medium" selected>Medium</option>
                  <option value="High">High</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Tags</label>
                <input name="tags" placeholder="e.g., work, urgent" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-300 dark:focus:ring-indigo-500" />
              </div>
            </div>
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Add Task</button>
          </div>
        </form>

        <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Tasks</h2>
        <div class="space-y-2">
          {% if tasks %}
            {% for t in tasks %}
              <div class="flex items-start justify-between p-4 border border-gray-200 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 flex items-center justify-center rounded-full text-white text-sm font-semibold
                                {% if t.status == 'Completed' %}bg-green-500{% elif t.priority == 'High' %}bg-red-500{% elif t.priority == 'Medium' %}bg-yellow-500{% else %}bg-blue-500{% endif %}">
                      {{ t.id }}
                    </div>
                    <div class="flex-1">
                      <div class="font-medium text-gray-900 dark:text-white {% if t.status == 'Completed' %}line-through text-gray-500 dark:text-gray-400{% endif %}">{{ t.title }}</div>
                      <div class="text-xs mt-1 flex flex-wrap gap-2">
                        <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded">
                          Status: <span class="font-semibold {% if t.status == 'Completed' %}text-green-600 dark:text-green-400{% else %}text-yellow-600 dark:text-yellow-400{% endif %}">{{ t.status }}</span>
                        </span>
                        <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded">
                          Priority: <span class="font-semibold">{{ t.priority }}</span>
                        </span>
                        {% if t.due_date %}
                          <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded">
                            Due: {{ t.due_date.strftime('%Y-%m-%d %H:%M') }}
                          </span>
                        {% endif %}
                        {% if t.tags %}
                          {% for tag in t.tags.split(',') %}
                            <span class="px-2 py-1 bg-purple-200 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded text-xs">{{ tag.strip() }}</span>
                          {% endfor %}
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  
                  <!-- Comments Section -->
                  <div class="mt-4 border-t border-gray-200 dark:border-gray-600 pt-4">
                    <div class="flex items-center justify-between mb-3">
                      <button onclick="toggleComments({{ t.id }})" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        Comments (<span id="comment-count-{{ t.id }}">0</span>)
                      </button>
                    </div>
                    
                    <div id="comments-{{ t.id }}" class="hidden space-y-3">
                      <!-- Comments List -->
                      <div id="comments-list-{{ t.id }}" class="space-y-2">
                        <!-- Comments will be loaded here -->
                      </div>
                      
                      <!-- Add Comment Form -->
                      <div class="border-t border-gray-200 dark:border-gray-600 pt-3">
                        <form onsubmit="addComment(event, {{ t.id }})" class="flex gap-2">
                          <input type="text" id="comment-input-{{ t.id }}" placeholder="Add a comment..." maxlength="1000"
                                 class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-300 dark:focus:ring-blue-500" />
                          <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded">Add</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex items-center gap-2 ml-4 flex-shrink-0">
                  <a href="{{ url_for('toggle_task', task_id=t.id) }}" class="text-sm px-3 py-1 rounded border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-500">{% if t.status == 'Completed' %}Undo{% else %}Complete{% endif %}</a>
                  <a href="{{ url_for('edit_task', task_id=t.id) }}" class="text-sm px-3 py-1 rounded border border-blue-300 dark:border-blue-600 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900">Edit</a>
                  <a href="{{ url_for('delete_task', task_id=t.id) }}" class="text-sm px-3 py-1 rounded border border-red-300 dark:border-red-600 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900">Delete</a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center text-gray-500 dark:text-gray-400 py-12">No tasks yet — add your first task above.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <script>
      // Load and display stats
      async function loadStats() {
        try {
          const response = await fetch('/api/stats/summary');
          const data = await response.json();
          
          document.getElementById('stat-completed-today').textContent = data.completed_today;
          document.getElementById('stat-completed-week').textContent = data.completed_week;
          document.getElementById('stat-overdue').textContent = data.overdue;
          document.getElementById('stat-pending').textContent = data.total_pending;
          document.getElementById('stat-total-completed').textContent = data.total_completed;
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      // Load and display completion trend chart
      async function loadTrendChart() {
        try {
          const response = await fetch('/api/stats/completion-trend?days=7');
          const data = await response.json();
          
          const labels = [];
          const values = [];
          
          for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            labels.push(dateStr);
            values.push(data.trend[dateStr] || 0);
          }
          
          const ctx = document.getElementById('trendChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Tasks Completed',
                data: values,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true, labels: { color: '#6b7280', font: { size: 12 } } }
              },
              scales: {
                y: { beginAtZero: true, ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } },
                x: { ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } }
              }
            }
          });
        } catch (error) {
          console.error('Error loading trend chart:', error);
        }
      }

      // Load and display priority chart
      async function loadPriorityChart() {
        try {
          const response = await fetch('/api/stats/by-priority');
          const data = await response.json();
          
          const ctx = document.getElementById('priorityChart').getContext('2d');
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: Object.keys(data),
              datasets: [{
                data: Object.values(data),
                backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                borderColor: '#1f2937',
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom', labels: { color: '#6b7280', padding: 15, font: { size: 12 } } }
              }
            }
          });
        } catch (error) {
          console.error('Error loading priority chart:', error);
        }
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadTrendChart();
        loadPriorityChart();
      });

      // Comments functionality
      async function toggleComments(taskId) {
        const commentsDiv = document.getElementById(`comments-${taskId}`);
        const isHidden = commentsDiv.classList.contains('hidden');
        
        if (isHidden) {
          commentsDiv.classList.remove('hidden');
          await loadComments(taskId);
        } else {
          commentsDiv.classList.add('hidden');
        }
      }

      async function loadComments(taskId) {
        try {
          const response = await fetch(`/api/comments/${taskId}`);
          const comments = await response.json();
          
          const commentsList = document.getElementById(`comments-list-${taskId}`);
          const commentCount = document.getElementById(`comment-count-${taskId}`);
          
          commentCount.textContent = comments.length;
          
          if (comments.length === 0) {
            commentsList.innerHTML = '<div class="text-sm text-gray-500 dark:text-gray-400 italic">No comments yet</div>';
            return;
          }
          
          commentsList.innerHTML = comments.map(comment => `
            <div class="flex gap-3 p-3 bg-gray-50 dark:bg-gray-600 rounded">
              <div class="flex-1">
                <div class="text-sm text-gray-900 dark:text-white">${escapeHtml(comment.body)}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  ${new Date(comment.created_at).toLocaleString()}
                  ${comment.author_id ? ` • Author #${comment.author_id}` : ''}
                </div>
              </div>
              <button onclick="deleteComment(${comment.id}, ${taskId})" 
                      class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          `).join('');
        } catch (error) {
          console.error('Error loading comments:', error);
        }
      }

      async function addComment(event, taskId) {
        event.preventDefault();
        
        const input = document.getElementById(`comment-input-${taskId}`);
        const body = input.value.trim();
        
        if (!body) return;
        
        try {
          const response = await fetch('/api/comments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              task_id: taskId,
              body: body
            })
          });
          
          if (response.ok) {
            input.value = '';
            await loadComments(taskId);
          } else {
            const error = await response.json();
            alert('Error: ' + error.error);
          }
        } catch (error) {
          console.error('Error adding comment:', error);
          alert('Error adding comment');
        }
      }

      async function deleteComment(commentId, taskId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;
        
        try {
          const response = await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            await loadComments(taskId);
          } else {
            const error = await response.json();
            alert('Error: ' + error.error);
          }
        } catch (error) {
          console.error('Error deleting comment:', error);
          alert('Error deleting comment');
        }
      }

      // Helper function to escape HTML and prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>

